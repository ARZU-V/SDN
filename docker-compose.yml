version: '3.8'

services:
  # VNF - The Message Queue "Broker"
  redis:
    image: "redis:alpine"
    hostname: redis
    # Expose Redis to the host so ingest/broadcast can find it at 127.0.0.1
    ports:
      - "6379:6379"

  # VNF 1: Ingest Service (Captures Video)
  ingest:
    build: .
    command: python ingest_service/main.py
    depends_on:
      - redis
    environment:
      - PHONE_WS_URL=ws://192.168.1.101:8080/video
      # Uses localhost because it is on 'host' network
      - REDIS_HOST=127.0.0.1
    network_mode: "host"
    
    # --- WEBCAM PERMISSIONS ---
    privileged: true
    devices:
      - "/dev/video0:/dev/video0"
      - "/dev/video1:/dev/video1"

  # VNF 2: Detection Service (AI Processing)
  detection:
    build: .
    command: python detection_service/main.py
    depends_on:
      - redis
    environment:
      # Uses 'redis' hostname because it is on internal docker network
      - REDIS_HOST=redis
    deploy:
      replicas: 1

  # VNF 3: Broadcast Service (Sends Video to Quest)
  broadcast:
    build: .
    command: python broadcast_service/main.py
    depends_on:
      - redis
    environment:
      - REDIS_HOST=127.0.0.1
    network_mode: "host"
    
    # --- SSL CERTIFICATES ---
    # Maps the certificates from your project folder into the container
    # This enables WSS:// support
    volumes:
      - ./cert.pem:/app/cert.pem
      - ./key.pem:/app/key.pem

  # VNF 4: Legacy Web Server (Backup)
  # (You are currently using run_secure.py instead of this)
  web-server:
    build: .
    command: python -m http.server 8000
    ports:
      - "8000:8000"